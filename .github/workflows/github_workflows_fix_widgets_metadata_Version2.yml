name: Fix Notebook Widgets Metadata

on:
  workflow_dispatch:
  push:
    paths:
      - '**.ipynb'

jobs:
  fix-notebook-widgets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install nbformat
        run: pip install nbformat

      - name: Fix notebook widgets metadata in all .ipynb files
        run: |
          python -c "
import glob
import nbformat

def fix_widgets_metadata(ipynb_path):
    nb = nbformat.read(ipynb_path, as_version=nbformat.NO_CONVERT)
    if 'widgets' in nb.metadata:
        print(f'Removing widgets from {ipynb_path}')
        del nb.metadata['widgets']
        nbformat.write(nb, ipynb_path)
        return True
    return False

fixed = False
for nb in glob.glob('**/*.ipynb', recursive=True):
    if fix_widgets_metadata(nb):
        fixed = True
if fixed:
    print('Some notebooks were fixed. Please commit the changes.')
else:
    print('No notebook widgets metadata needed fixing.')
          "

      - name: Commit and push changes if any
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix(ci): Remove broken 'widgets' metadata from Jupyter notebooks"
          file_pattern: "*.ipynb"
          push_options: --force
